# ğŸ’» ê°œë°œ í™˜ê²½
- Unity 2019.4.32f1
- WebGL
- Redis:alpine
- nginx-rtmp-module
- ffmpeg version 4.2.4-1ubuntu0.1 (built with gcc 9)
- youtube-dl 2021.06.06
- Open JDK 1.8
- Spring Boot 2.5.6
- Gradle `gradle-7.2`
- IntelliJ IDEA 2021.2.3 (Ultimate Edition)
- Vuejs 2.6.11
- Vuex 3.6.2
- Vuex-persistance 4.1.0
- Amazon Firebase ReatileDB
- hls.js 1.1.1
- core-js 3.6.5

# ğŸ” ì™¸ë¶€ ì„œë¹„ìŠ¤ ì •ë³´

## âœ… í¬í†¤

https://doc.photonengine.com/ko-kr/pun/current/getting-started/pun-intro

ì‚¬ì´íŠ¸ íšŒì›ê°€ì…/ë¡œê·¸ì¸ í›„ AppIDë¥¼ ë°œê¸‰ë°›ì•„

ìœ ë‹ˆí‹° í”„ë¡œì íŠ¸ì—ì„œ AssetStoreë¥¼ í†µí•´ Photon Voice2 ì—ì…‹ì„ ì¶”ê°€í•œ í›„ ë°œê¸‰ë°›ì€ AppIDë¡œ Setup Wizardë¥¼ ì§„í–‰ í›„ ì‚¬ìš© ê°€ëŠ¥



## âœ… ì†Œì…œ ë¡œê·¸ì¸

### êµ¬ê¸€ ë¡œê·¸ì¸

- https://console.cloud.google.com/apis?pli=1 ì‚¬ì´íŠ¸ì— ì ‘ì†í•˜ì—¬
- í”„ë¡œì íŠ¸ ìƒì„±

![Untitled](./images/google1.png)

- Oauth 2.0 í´ë¼ì´ì–¸íŠ¸ IDì™€ ë³´ì•ˆ ë¹„ë°€ì„ ë°›ëŠ”ë‹¤.
- ìŠ¹ì¸ëœ ë¦¬ë””ë ‰ì…˜ URIì— ìš°ë¦¬ ì‚¬ì´íŠ¸ë¥¼ ë“±ë¡í•´ì¤€ë‹¤.

![Untitled1](./images/google2.png)

- application-secrity.yml íŒŒì¼ì„ ìƒì„±í•˜ì—¬

```
spring:
  security:
    oauth2.client:
      registration:
        google:
          clientId: {ì—¬ê¸°ì— ë°œê¸‰ë°›ì€ ê°’ ê°ê° ê°’ ë„£ì–´ì¤Œ}
					clientSecret: {ì—¬ê¸°ì— ë°œê¸‰ë°›ì€ ê°’ ê°ê° ê°’ ë„£ì–´ì¤Œ}
					scope:
            - email
            - profile
```

### ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸

- https://developers.kakao.com/ ì‚¬ì´íŠ¸ì— ì ‘ì†í•˜ì—¬
- ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ìƒì„±í•œë‹¤

![Untitled2](./images/kakao1.png)

- Rest API í‚¤( ì¶”í›„ Client-ID )ë¥¼ ì €ì¥í•˜ê³ , ì´ê²ƒì„ ê°€ì§€ê³  Client-Secretë„ í•¨ê»˜ ìƒì„±í•œë‹¤.
- ë¦¬ë””ë ‰ì…˜ URIë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ë“±ë¡í•´ì¤€ë‹¤.

![Untitled3](./images/kakao2.png)

- ì•„ë˜ì²˜ëŸ¼ ymlíŒŒì¼ì— ë“±ë¡í•œë‹¤.

```
spring:
  security:
    oauth2.client:
      registration:
        kakao:
          clientId: {ì—¬ê¸°ì— ë°œê¸‰ë°›ì€ ê°’ ê°ê° ê°’ ë„£ì–´ì¤Œ}
					clientSecret: {ì—¬ê¸°ì— ë°œê¸‰ë°›ì€ ê°’ ê°ê° ê°’ ë„£ì–´ì¤Œ}
					clientAuthenticationMethod: post
          authorizationGrantType: authorization_code
					redirectUri: <https://k5a304.p.ssafy.io/login/oauth2/code/kakao>
					clientName: Kakao
```

- ì¹´ì¹´ì˜¤ì—ì„œ ì–´ë– í•œ í•­ëª©ë„ í•„ìˆ˜ë¡œ ë°›ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ë³„ë„ì˜ ê²€ìˆ˜ë¥¼ ê±°ì¹˜ì§€ ì•Šê³ ë„ ì‚¬ìš©í•  ìˆ˜ ìˆì—ˆë‹¤.
- build.gradleì— ì¶”ê°€

```
implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
implementation 'org.springframework.boot:spring-boot-starter-security'
```
## âœ… ê¸°íƒ€ ì™¸ë¶€ API
### spotify API
https://developer.spotify.com/

í•´ë‹¹ ì‚¬ì´íŠ¸ì— ì ‘ì†í•˜ì—¬ Spotify ê°€ì… > ë¡œê·¸ì¸ > Dashboard > Spotify App ìƒì„±í•œ ë’¤, Client IDì™€ secret KEYë¥¼ ë°›ëŠ”ë‹¤.

Spotify APIë¥¼ ìš”ì²­ì´ í•„ìš”í•  ë•Œë§ˆë‹¤, ë°œê¸‰ë°›ì€ Client IDì™€ secret KEYë¡œ `https://accounts.spotify.com/api/token, Client id, client secret` ë¡œ POST ìš”ì²­ì„ ë³´ë‚´ ì‘ë‹µìœ¼ë¡œ ë°›ì•„ì˜¨ Access Tokenì„ ì‚¬ìš©í•œë‹¤.

ì°¸ê³  : https://pearlluck.tistory.com/488

### youtube API
https://developers.google.com/youtube/v3/getting-started?hl=ko
ë¥¼ ì°¸ê³ í•˜ì—¬ APIí‚¤ë¥¼ ë°œê¸‰ë°›ì•„ ì‚¬ìš©í•œë‹¤.

google API ì½˜ì†”> ì• í”Œë¦¬ì¼€ì´ì…˜ ë“±ë¡ > Youtube Data API ì„œë¹„ìŠ¤ ì„ íƒ > API ëª©ë¡ì—ì„œ YouTube Data API ìƒíƒœ ON

í•´ë‹¹ ì½˜ì†”ì—ì„œ ë°›ì€ Access keyë¥¼ API ìš”ì²­ì‹œ ì‚¬ìš©í•˜ë„ë¡ í•œë‹¤.

ì°¸ê³  : https://senticoding.tistory.com/37


# ğŸ›  Porting Manual

## ğŸ’» ë¡œì»¬ í˜¸ìŠ¤íŠ¸

### MobaXterm ì„¤ì¹˜

[ê³µì‹ í™ˆí˜ì´ì§€ ë‹¤ìš´ë¡œë“œ í˜ì´ì§€](https://mobaxterm.mobatek.net/download.html)ì—ì„œ Home Edition(Free) â†’ Portable edition(ë¬´ì„¤ì¹˜) ë‹¤ìš´ë¡œë“œ ì••ì¶• í’€ê³  ì‹¤í–‰í•´ ì‚¬ìš©

ì²˜ìŒ ì‹¤í–‰ì‹œ ì™¼ìª½ ìƒë‹¨ Session í´ë¦­í•´ ì„œë²„ ì •ë³´ ë“±ë¡

Advanced SSH settings ì—ì„œ Use private key ì„ íƒí•˜ê³  ì œê³µë°›ì€ ì„œë²„ í‚¤ ë“±ë¡ â†’ OKí•˜ë©´ ì›ê²© ì ‘ì† ì„¸ì…˜ ì‹œì‘.

## ğŸ–¥ ì²« ë²ˆì§¸ ìš°ë¶„íˆ¬(ì„œë²„)ì—ì„œ
### ìŒì•… ìŠ¤íŠ¸ë¦¬ë°ì— í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
_ë¡œì»¬ í˜¸ìŠ¤íŠ¸ì—ì„œ í…ŒìŠ¤íŒ…í•˜ê³ ì í•œë‹¤ë©´ ì„¤ì¹˜ í•„ìˆ˜_

```bash
sudo apt-get update
sudo apt install ffmpeg
sudo apt install youtube-dl
```

### Docker ì„¤ì¹˜

ì°¸ê³  url: [Docker Install Guide](https://docs.docker.com/engine/install/ubuntu/)

Install using the repository

```bash
sudo apt-get update

sudo apt-get install \\
    ca-certificates \\
    curl \\
    gnupg \\
    lsb-release

curl -fsSL <https://download.docker.com/linux/ubuntu/gpg> | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

echo \\
  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] <https://download.docker.com/linux/ubuntu> \\
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

Install Docker Engine (latest version)

```bash
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io
```

ì„¤ì¹˜ í™•ì¸

```bash
sudo docker run hello-world
```

### docker-compose ì„¤ì¹˜

```docker
sudo apt-get install docker-compose
sudo docker-compose version
```



## ì  í‚¨ìŠ¤ ì„¤ì¹˜

- Dockerfile

```
FROM jenkins/jenkins
USER $USER
RUN curl -s https://get.docker.com/ | sh
RUN curl -L "https://github.com/docker/compose/releases/download/1.28.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose && \
    chmod +x /usr/local/bin/docker-compose && \
    ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
RUN curl -sL bit.ly/ralf_dcs -o ./dcs && \
    chmod 755 dcs && \
    mv dcs /usr/local/bin/dcs
RUN usermod -aG docker jenkins
```

- docker-compose.yml

```
version: '3'
services:
  jenkins:
    privileged: true
    build: .
    restart: always
    ports:
      - "9090:8080"
      - "50000:50000"
    expose:
      - "9090"
      - "50000"
    volumes:
      - './jenkins_space:/var/jenkins_home'
      - '/var/run/docker.sock:/var/run/docker.sock'
    environment:
      TZ: "Asia/Seoul"

```

/home/ubuntu ì— ë‘ íŒŒì¼ ìœ„ì¹˜ì‹œí‚¤ê³  docker-compose up -d



### ì  í‚¨ìŠ¤ íŠ¸ë¦¬ê±° ì„¤ì •

Jenkins ê´€ë¦¬ â†’ (System Configuration) í”ŒëŸ¬ê·¸ì¸ ê´€ë¦¬ â†’ gitlab ê²€ìƒ‰í•´ì„œ ì„¤ì¹˜

Jenkins ê´€ë¦¬ â†’ (Security) Manage Credentials

ì  í‚¨ìŠ¤ì—ì„œ íƒ€ ì‹œìŠ¤í…œì— ì ‘ì†í•  ë•Œ ì•„ì´ë””/íŒ¨ìŠ¤ì›Œë“œ ê³„ì • ì •ë³´ë¥¼ ê´€ë¦¬í•˜ëŠ” ê³³

![jenkins1](./images/jenkins1.png)

jenkins í´ë¦­ â†’ global credentials â†’ ì¢Œì¸¡ Add Credentials

![jenkins2](./images/jenkins2.png)

username ì— ê¹ƒë© ê³„ì • ì•„ì´ë””

password ì— ê¹ƒë© ê³„ì • ë¹„ë°€ë²ˆí˜¸

ID ì—ëŠ” ì  í‚¨ìŠ¤ì—ì„œ í•´ë‹¹ credentialì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ ì“¸ ì•„ì´ë”” ì ë‹¹íˆ

í”„ë¡œì íŠ¸ì˜ êµ¬ì„± í˜¹ì€ í”„ë¡œì íŠ¸ ë§Œë“¤ ë•Œ ì„¤ì •

![jenkins3](./images/jenkins3.png)

ì›¹í›… URL ë³µì‚¬í•´ë‘ê¸°(gitlab ì„¤ì •í•  ë•Œ ì‚¬ìš©)

ìš°ì¸¡ í•˜ë‹¨ ê³ ê¸‰ ëˆ„ë¥´ê³  Secret token í•­ëª©ì—ì„œ Generate ëˆŒëŸ¬ ìƒì„±ë˜ëŠ” tokenë„ ë³µì‚¬í•´ë‘ê¸°

gitlab â†’ í”„ë¡œì íŠ¸ í´ë¦­ â†’ Setting â†’ Webhook

![gitlab1](./images/gitlab1.png)

URLì— Jenkinsì—ì„œ ë³µì‚¬í•œ ì›¹í›… URL ì…ë ¥.

secret tokenì— ì•„ê¹Œ ë³µì‚¬í•œ secret token ì…ë ¥.

Push eventsëŠ” developì— í•œì •í•˜ê¸°

Add Webhook í•˜ê³  test ëˆŒëŸ¬ì„œ push events í•´ì„œ Jenkinsì—ì„œ ë¹Œë“œ ì‹œì‘í•˜ë©´ ì—°ê²° ì˜ ëœ ê²ƒ. (testëŠ” í”„ë¡œì íŠ¸ ì„¤ì • ì™„ë£Œí•œ í›„ì—)

![jenkins4](./images/jenkins4.png)

pipelineì€ ìœ„ì™€ ê°™ì´ ì„¤ì •. Pipeline script from SCM í•˜ë©´ Git ìµœìƒë‹¨ ë£¨íŠ¸ì— ìˆëŠ” Script Pathë¡œ ë“±ë¡ëœ íŒŒì¼(ê¸°ë³¸: Jenkinsfile)ì— ìˆëŠ” ìŠ¤í¬ë¦½íŠ¸ ì”€.

ê¹ƒ URL ì“°ê³  Credentialsì—ëŠ” ë“±ë¡í•´ë‘” Gitlab Credential ì‚¬ìš©.

Branches to build ëŠ” ë§ ê·¸ëŒ€ë¡œ ë¹Œë“œ/ë°°í¬ ëŒ€ìƒì´ ë  ë¸Œëœì¹˜. develop

ë‹¤ë¥¸ ë¸Œëœì¹˜ë¡œ ì‹¤í—˜í•´ë³¼ ë•ŒëŠ” ê·¸ ë¸Œëœì¹˜ ì´ë¦„ìœ¼ë¡œ í•˜ë©´ ë¨.



## DB

```
# ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
docker pull mariadb
# ì»¨í…Œì´ë„ˆ êµ¬ë™
docker run --name mariadb -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=mariadb mariadb -e LC_ALL=C.UTF-8 mysql:8
```

ì„œë²„ì— db í´ë”ì— dump íŒŒì¼ ì—…ë¡œë“œ í›„ mariadb ì»¨í…Œì´ë„ˆì— ì˜®ê¸°ê¸°

```
docker cp [host íŒŒì¼ê²½ë¡œ] [container name]:[container ë‚´ë¶€ ê²½ë¡œ]
docker cp ./comu1.sql mariadb:home
```

mariadb ì ‘ì†í•´ dump

```
docker exec -it mariadb /bin/bash
mysql -u root -p comu < ./home/comu1.sql
```

docker network ì„¤ì •

```
docker network create mysql
docker network connect mysql mariadb
```



## ë°±ì—”ë“œ

- redis ì´ë¯¸ì§€ ë°›ì•„ì˜¤ê¸° ë° ì»¨í…Œì´ë„ˆ ìƒì„± ë° êµ¬ë™

```
docker pull redis:alpine
docker run -p 6379:6379 --name redis_boot -d redis:alpine
```

- docker network êµ¬ì¶•

```
docker network create redis-back
docker network connect redis-back redis_boot
```

- Dockerfile

```
# build stage
FROM openjdk:8-jdk-alpine as builder
# RUN addgroup -S spring && adduser -S spring -G spring
# USER spring:spring

COPY . .
# RUN chmod +x ./gradlew
RUN ./gradlew clean build -x test
RUN mkdir -p build/dependency
WORKDIR build/dependency
RUN jar -xf ../libs/Comu-0.0.1-SNAPSHOT.jar
WORKDIR ../..

# product stage
FROM openjdk:8-jdk-alpine
ARG DEPENDENCY=build/dependency
COPY --from=builder ${DEPENDENCY}/BOOT-INF/lib /app/lib
COPY --from=builder ${DEPENDENCY}/META-INF /app/META-INF
COPY --from=builder ${DEPENDENCY}/BOOT-INF/classes /app
ENTRYPOINT ["java","-cp","app:app/lib/*","com.listener.comu.BackendApplication"]
```



### ë¡œì»¬ íŒŒì¼ resources ë°˜ì˜

MobaXterm/Putty ë“±ìœ¼ë¡œ ì„œë²„ì— ì ‘ì†í•œ í›„

`home/ubuntu/jenkins_space/workspace/comu_v1/backend/src/main/resources` ì— ìˆëŠ” íŒŒì¼ì„

`sudo vi application*.yml` ëª…ë ¹ì–´ë¡œ ì—´ì–´ì„œ ìˆ˜ì •í•˜ì‹œë©´ ë©ë‹ˆë‹¤.



## í”„ë¡ íŠ¸ì—”ë“œ (Vue + nginx)

- Dockerfile

```
# build stage
FROM node:14-alpine as build-stage
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# production stage
FROM nginx:stable-alpine as production-stage
COPY ./nginx.conf /etc/nginx/nginx.conf
COPY ./comu.conf /etc/nginx/conf.d/comu.conf
COPY --from=build-stage /app/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

- nginx.conf

```
user                    nginx;
worker_processes        1;
error_log               /var/log/nginx/error.log warn;
pid                     /var/run/nginx.pid;
events {
    worker_connections  1024;
}

http {
    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;
    log_format          main '$remote_addr - $remote_user [$time_local] "$request" '
                             '$status $body_bytes_sent "$http_referer"'
                             '"$http_user_agent" "$http_x_forwarded_for"';
    access_log          /var/log/nginx/access.log main;
    sendfile            on;
    keepalive_timeout   65;
    include /etc/nginx/conf.d/comu.conf;
}

```

- comu.conf

```
# ìš”ì²­ì„ ì˜êµ¬ì ìœ¼ë¡œ httpsë¡œ redirect ì²˜ë¦¬í•˜ëŠ” ì„¤ì • ì¶”ê°€
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    location / {
        return 301 https://$host$request_uri;
    }
}

# ê¸°ì¡´ ì„¤ì •ì„ https(443)ìš©ìœ¼ë¡œ ì„¤ì •í•˜ê³  TLS ì„¤ì •ì„ ìƒˆë¡­ê²Œ ì¶”ê°€
server {
    # listen 80 default_server;
    # listen [::]:80 default_server;

    listen 443 ssl default_server;
    listen [::]:443 ssl default_server;

    # ssl ì¸ì¦ì„œ ìœ„ì¹˜ ë° TLS ì„¤ì • ì¶”ê°€
    ssl_certificate /etc/letsencrypt/live/k5a304.p.ssafy.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/k5a304.p.ssafy.io/privkey.pem;
    ssl_session_cache shared:le_nginx_SSL:10m;
    ssl_session_timeout 1440m;
    ssl_session_tickets off;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';

    server_name     k5a304.p.ssafy.io;
    index           index.html;
    
    location / {
        root        /usr/share/nginx/html;
        index       index.html;
        try_files   $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://backend:8080;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
    }

    location /login/oauth2 {
        proxy_pass http://backend:8080;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
    }
}
```

### ssl ì„¤ì •

- Dockerë¡œ ì¸ì¦ì„œ ë°œê¸‰

```
docker run -it --rm --name cert_tmp -p 80:80 -v /home/ubuntu/cert:/etc/letsencrypt certbot/certbot certonly \
--standalone -d k5a302.p.ssafy.io -m [your email]
```



## ì  í‚¨ìŠ¤ ì„¤ì •

- Jenkinsfile

```
pipeline {
	agent any
	stages {
		stage('spring-build-deploy') {
			steps {
				script {
					try {
						mattermostSend (
							color: "#ff7f00",
							message: "spring-build-deploy ì‹œì‘: ${env.JOB_NAME} #${env.BUILD_NUMBER} (<${env.BUILD_URL}|Link to build>)"
						)
						sh 'docker rm -f backend'
						sh 'docker build -t dockerize-spring-boot-app ./backend'
						sh 'docker run --name backend --network mysql -d -p 8080:8080 dockerize-spring-boot-app'
						sh 'docker network connect front-back backend'
						sh 'docker network connect redis-back backend'
					} catch(e) {
						currentBuild.result = "FAILURE"
					} finally {
						if(currentBuild.result == "FAILURE") {
							mattermostSend (
								color: "danger",
								message: "spring-build-deploy ì‹¤íŒ¨: ${env.JOB_NAME} #${env.BUILD_NUMBER} (<${env.BUILD_URL}|Link to build>)"
							)
						} else {
							mattermostSend (
								color: "good",
								message: "spring-build-deploy ì„±ê³µ: ${env.JOB_NAME} #${env.BUILD_NUMBER} (<${env.BUILD_URL}|Link to build>)"
							)
						}
					}
				}
			}
		}
		stage('vue-build-deploy') {
			steps {
				script {
					try {
						mattermostSend (
							color: "#ff7f00",
							message: "vue-build-deploy ì‹œì‘: ${env.JOB_NAME} #${env.BUILD_NUMBER} (<${env.BUILD_URL}|Link to build>)"
						)
						sh 'docker rm -f frontend'
						sh 'docker build -t dockerize-vuejs-app ./frontend'
						sh 'docker container prune -f'
						sh 'docker rmi $(docker images -f dangling=true -q)'
						sh 'docker run --name frontend --network front-back -d -p 80:80 -p 443:443 -v /home/ubuntu/cert/:/etc/letsencrypt/ dockerize-vuejs-app'
					} catch(e) {
						currentBuild.result = "FAILURE"
					} finally {
						if(currentBuild.result == "FAILURE") {
							mattermostSend (
								color: "danger",
								message: "vue-build-deploy ì‹¤íŒ¨: ${env.JOB_NAME} #${env.BUILD_NUMBER} (<${env.BUILD_URL}|Link to build>)"
							)
						} else {
							mattermostSend (
								color: "good",
								message: "vue-build-deploy ì„±ê³µ: ${env.JOB_NAME} #${env.BUILD_NUMBER} (<${env.BUILD_URL}|Link to build>)"
							)
						}
					}
				}
			}
		}
	}
}

```
## ğŸ–¥ ë‘ ë²ˆì§¸ ìš°ë¶„íˆ¬(ë¯¸ë””ì–´ ì„œë²„)ì—ì„œ
### nginx-rtmp ëª¨ë“ˆ ì„¤ì¹˜
_â—ï¸httpsë¥¼ ì ìš©í•´ì•¼ í•˜ë¯€ë¡œ ì„ í–‰ì ìœ¼ë¡œ letsencryptì˜ ì¸ì¦ì„œë¥¼ ë°œê¸‰ ë°›ë„ë¡ í•œë‹¤._
#### âœ”ï¸ í•„ìš”í•œ ë¹Œë“œ ë„êµ¬ ì„¤ì¹˜í•˜ê¸°
nginxë¥¼ ì»´íŒŒì¼ë§ í•˜ê¸° ì „ì— autoconf, gcc, git, makeë¥¼ ì„¤ì¹˜í•´ì•¼ í•¨
```bash
$ sudo apt update
$ sudo apt install build-essential git
```

#### âœ”ï¸ Nginxì— í•„ìš”í•œ ì˜ì¡´ì„± ì„¤ì¹˜í•˜ê¸°
Perl Compatible Regular Expressions (PCRE), OpenSSL, zlibì„ ì„¤ì¹˜í•œë‹¤.
* PCRE : ì •ê·œì‹ì„ ì§€ì›. Nginx Coreì™€ rewrite ëª¨ë“ˆë“¤ì—ì„œ í•„ìš”í•˜ë‹¤ 
* zlib : httpì—ì„œ í—¤ë”ë¥¼ ì»´í”„ë ˆì‹±(ì••ì¶•)ì„ ì§€ì›. Nginx Gzip ëª¨ë“ˆì— í•„ìš”í•˜ë‹¤.
* OpenSSL : https í”„ë¡œí† ì½œì„ ì§€ì›í•˜ê³ , Nginx SSL ëª¨ë“ˆì—ì„œ í•„ìš”í•˜ë‹¤.
```bash
$ sudo apt install libpcre3-dev libssl-dev zlib1g-dev
```
#### âœ”ï¸ Nginx git cloneìœ¼ë¡œ ë°›ì•„ì˜¤ê¸°, RTMP ëª¨ë“ˆê³¼ í•¨ê»˜ nginx ì»´íŒŒì¼í•˜ê¸°
```bash
$ cd ~
$ git clone https://github.com/arut/nginx-rtmp-module.git
$ git clone https://github.com/nginx/nginx.git
$ cd nginx
$ ./auto/configure --add-module=../nginx-rtmp-module
$ make
$ sudo make install
```

#### âœ”ï¸ ë°›ì•„ì˜¨ nginxì˜ nginx.confíŒŒì¼ì„ ìˆ˜ì •í•˜ê³ , ê°€ë™ì‹œí‚¨ë‹¤.

_nginxì˜ conf íŒŒì¼ì„ ë°”ë¡œ ìˆ˜ì •í•˜ê³  ì ìš©í•˜ëŠ”ë° ìœ„í—˜ì„ ì¤„ì´ê³ ì ë³µì‚¬í•˜ì—¬ overwriteí•˜ë„ë¡ í•œë‹¤._

ë³µì‚¬í•˜ê¸° ì „ ì‘ì—… íŒŒì¼ì„ ì—´ì–´ ì‘ì—…í›„ ì‹¤ì œ nginx ê²½ë¡œì— ë³µì‚¬í•œë‹¤.(git clone ë°›ì•„ì˜¨ í”„ë¡œì íŠ¸ì— ìˆëŠ” íŒŒì¼ì„ ì‚¬ìš©)
```bash
$ vi ./nginx/nginx/conf/nginx.conf
$ sudo cp ./nginx/nginx/conf/nginx.conf /usr/local/nginx/conf/nginx.conf
```

```javascript
#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;

events {
worker_connections  1024;
}

rtmp {
  server {
    listen 1935;
    application live1 {
      live on;
      interleave on;
      hls on;
      hls_path /tmp/hls/1;
      hls_fragment 5s;
    }
    application live2 {
      live on;
      interleave on;
      hls on;
      hls_path /tmp/hls/2;
      hls_fragment 5s;
    }
    application live3 {
      live on;
      interleave on;
      hls on;
      hls_path /tmp/hls/1;
      hls_fragment 5s;
    }
    application live4 {
      live on;
      interleave on;
      hls on;
      hls_path /tmp/hls/1;
      hls_fragment 5s;
    }
    application live5 {
      live on;
      interleave on;
      hls on;
      hls_path /tmp/hls/1;
      hls_fragment 5s;
    }
    application live6 {
      live on;
      interleave on;
      hls on;
      hls_path /tmp/hls/1;
      hls_fragment 5s;
    }
  ]
}
http {
  sendfile off;
  tcp_nopush on;
  directio 512;
  default_type  application/octet-stream;

  server {
    listen 80;
    listen [::]:80;
    server_name  localhost;
    return 301 https://$host$request_uri;
  }

  server {
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/localhost/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/localhost/privkey.pem;

    location / {
      # Disable cache
      add_header 'Cache-Control' 'no-cache';

      # CORS setup
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Expose-Headers' 'Content-Length';

      # allow CORS preflight requests
      if ($request_method = 'OPTIONS') {
          add_header 'Access-Control-Allow-Origin' '*';
          add_header 'Access-Control-Max-Age' 1728000;
          add_header 'Content-Type' 'text/plain charset=UTF-8';
          add_header 'Content-Length' 0;
          return 204;
      }

      root  /tmp;
			
      types {
        #hls ì„¤ì •
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
        text/html html;
        #dash ì„¤ì •
        #application/dash+xml mpd;
      }
    }	
  }
}
```

.confíŒŒì¼ ë¬¸ë²• í™•ì¸
```bash
$ sudo /usr/local/nginx/sbin/nginx -t
```

ë¬¸ë²•ì— ì´ìƒì´ ì—†ìœ¼ë©´ ì¬ê°€ë™í•˜ì—¬ rtmp ëª¨ë“ˆì„ ì ìš©í•˜ì—¬ ë¯¸ë””ì–´ ì„œë²„ë¥¼ ê°€ë™ì‹œí‚¨ë‹¤.
```bash 
$ sudo /usr/local/nginx/sbin/nginx
```

ì°¸ê³  : https://www.nginx.com/blog/video-streaming-for-remote-learning-with-nginx/#compile 
